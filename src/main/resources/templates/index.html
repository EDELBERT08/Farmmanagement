<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragments/layout}">

<head th:replace="~{fragments/layout :: head('Dashboard - FarmVista')}">
</head>

<body>

    <!-- Main Content replaced by layout -->
    <div layout:fragment="content">
        <!-- Dashboard Grid -->
        <div class="dashboard-container">

            <!-- Weather Widget -->
            <div class="weather-widget">
                <div class="weather-info">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <i class="fa-solid fa-cloud-sun" style="font-size:3rem;"></i>
                        <div>
                            <h3 th:text="${weatherTemp + '°C'}">24°C</h3>
                            <span th:text="${weatherCondition}">Sunny</span>
                        </div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-item">
                        <i class="fa-solid fa-wind"></i>
                        <p>12 km/h</p>
                    </div>
                    <div class="weather-item">
                        <i class="fa-solid fa-droplet"></i>
                        <p>45%</p>
                    </div>
                    <div class="weather-item">
                        <div style="background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:30px;">
                            <span th:text="${weatherLocation}">Chicago, US</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insight (If Available) -->
            <div class="weather-widget" style="background: linear-gradient(135deg, #2196F3, #64B5F6);"
                th:if="${farmInsights != null}">
                <div style="display:flex; align-items:center; gap:20px;">
                    <i class="fa-solid fa-lightbulb" style="font-size:2.5rem; color:#FFD700;"></i>
                    <div>
                        <h4 style="margin:0 0 5px 0;">Smart Farm Insight</h4>
                        <p style="margin:0; font-weight:400;" th:text="${farmInsights}">Insight loading...</p>
                    </div>
                </div>
            </div>

            <!-- Stats Container -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-info">
                        <h4>Total Crops</h4>
                        <p th:text="${totalCrops}">0</p>
                    </div>
                    <div class="stat-icon green">
                        <i class="fa-solid fa-seedling"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h4>Livestock</h4>
                        <p th:text="${totalAnimals}">0</p>
                    </div>
                    <div class="stat-icon orange">
                        <i class="fa-solid fa-cow"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h4>Total Income</h4>
                        <p th:text="${#numbers.formatCurrency(globalIncome)}">$0.00</p>
                    </div>
                    <div class="stat-icon blue">
                        <i class="fa-solid fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h4>Net Profit</h4>
                        <p th:text="${#numbers.formatCurrency(globalProfit)}"
                            th:style="${globalProfit >= 0} ? 'color:#4CAF50' : 'color:#d32f2f'">$0.00</p>
                    </div>
                    <div class="stat-icon purple">
                        <i class="fa-solid fa-chart-pie"></i>
                    </div>
                </div>
            </div>

            <!-- Charts & Side Panel -->
            <div class="chart-section">
                <h3 style="margin-top:0;">Production Overview</h3>
                <canvas id="productionChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="side-panel">
                <div class="production-card">
                    <h3 style="margin-top:0; font-size:1.1rem; margin-bottom:1rem;">Upcoming Tasks</h3>
                    <ul class="task-list">
                        <li class="task-item">
                            <div>
                                <span style="display:block; font-weight:600; font-size:0.9rem;">Fertilize Corn
                                    Field</span>
                                <span style="font-size:0.8rem; color:#888;">Due Today</span>
                            </div>
                            <span class="task-status status-pending">Pending</span>
                        </li>
                        <li class="task-item">
                            <div>
                                <span style="display:block; font-weight:600; font-size:0.9rem;">Safety Inspection</span>
                                <span style="font-size:0.8rem; color:#888;">Tomorrow</span>
                            </div>
                            <span class="task-status status-pending">Pending</span>
                        </li>
                        <li class="task-item">
                            <div>
                                <span style="display:block; font-weight:600; font-size:0.9rem;">Harvest Wheat</span>
                                <span style="font-size:0.8rem; color:#888;">Complete</span>
                            </div>
                            <span class="task-status status-done">Done</span>
                        </li>
                    </ul>
                    <a href="#"
                        style="display:block; text-align:center; margin-top:1rem; color:var(--primary-color); text-decoration:none; font-weight:600; font-size:0.9rem;">View
                        All Tasks</a>
                </div>
            </div>

        </div>

        <script th:inline="javascript">
            // Chart Data from Backend
            const cropData = [[${ cropDistribution }]];

            const ctx = document.getElementById('productionChart').getContext('2d');

            const labels = Object.keys(cropData);
            const data = Object.values(cropData);

            // Colors generator
            const bgColors = [
                'rgba(76, 175, 80, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(33, 150, 243, 0.7)',
                'rgba(156, 39, 176, 0.7)',
                'rgba(244, 67, 54, 0.7)'
            ];

            new Chart(ctx, {
                type: 'bar', // Can be 'doughnut' or 'bar'
                data: {
                    labels: labels.length > 0 ? labels : ['No Crops'],
                    datasets: [{
                        label: 'Crop Count by Type',
                        data: data.length > 0 ? data : [0],
                        backgroundColor: bgColors,
                        borderRadius: 5,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        </script>
    </div>

</body>

</html>